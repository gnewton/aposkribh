/github.com.gnewton.aposkribh.simple 100 dict def

github.com.gnewton.aposkribh.simple begin

/TestSuppressErrorMessages false def

/TestSuppressTestMessages false def
/TestSuppressTestErrorMessages false def

/initTesting{
    /TestSuppressErrorMessages true def
    /TestSuppressTestMessages false def
    /TestSuppressTestErrorMessages false def
    clear
}def



/AssertPass{ % proc testName
    10 dict begin
    /testName exch def  % Name of test being run
    testName isString? not{
        (/AssertPass: internal error: testName must be a string) testErrOut
        quit
    }if
    
    isProc? not{
        (Error: github.com.gnewton.aposkribh.simpletest/AssertPass: proc is not executable. Fix your test.) testErrOut
        testName testErrOut
        quit
    }if

    load /proc exch def % Procedure to test

    % ---body -----------------------
    {
        proc exec
    }
    stopped 
    { % Errors: not expected
        (FAIL /AssertPass) testMsgOut

        $error begin
        newerror =
        errorname =
        %command =
        errorinfo ==
        ostack ==
        estack ===
        
        dstack ==
        (End $error) =
        end
        TestStopOnFail
        {
            quit
        }if
    }if % stopped
    
    % No errors: expected
    (PASS /AssertPass) testMsgOut
    
    testName testMsgOut
    clear
    end
}def

/AssertFail{
    10 dict begin
    /testName exch def  % Name of test being run
    testName isString? not{
        (/AssertFail: internal error: testName must be a string) testErrOut
        quit
    }if
    
    isProc? not{
        (Error: github.com.gnewton.aposkribh.simpletest/AssertFail: proc is not executable. Fix this test.) testErrOut
        testName testErrOut
        quit
    }if

    load /proc exch def % Procedure to test
    
    {
        proc exec
    }
    stopped not{ % Wrong: Run with no errors: not expected
        (FAIL /AssertFail) testMsgOut
        TestStopOnFail{
            testName testMsgOut
            quit
        }
    }if

    % Failed: what is expected
    (PASS /AssertFail) testMsgOut
    testName testMsgOut
    clear
    end
 }def



/isProc?{
    dup
    10 dict begin
    {
        load /p exch def
        /p load xcheck{
            true
        }{
            false % Never get here...
            (Surprise) =
        }ifelse
    }stopped{ % if not executable, load will fail
        false
    }if
}def


/testErrOut{
    TestSuppressTestErrorMessages not{
        =
    }
    {
        pop
    }ifelse
}def

/testMsgOut{
    TestSuppressTestMessages not{
        =
    }
    {
        pop
    }ifelse
}def

/assertMinStackSize{ % proc num
     1 add count ge{
         (assertMinStackSize: Stack arguments missing) =
         =
         clear
         stop
     }if
     pop % proc
}bind def

end % github.com.gnewton.aposkribh.simpletest



/github.com.gnewton.aposkribh.simpletest.private 100 dict def

github.com.gnewton.aposkribh.simpletest.private begin




end % github.com.gnewton.aposkribh.simpletest.private 
